<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IoT Configurable</title>
    <!-- Incluir Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Incluir ApexCharts (necesario para ApexGraphWidget) -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .dashboard-column {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
        }
        .widget-container {
            flex-grow: 0;
        }
        /* Estilos adicionales para el LED si no están en Bootstrap */
        .led-circle {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
        }
        .led-circle.bg-success {
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.8), 0 0 20px rgba(40, 167, 69, 0.5);
        }
        .led-circle.bg-danger {
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.8), 0 0 20px rgba(220, 53, 69, 0.5);
        }
        .led-circle.bg-warning {
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.8), 0 0 20px rgba(255, 193, 7, 0.5);
        }
        .led-circle.bg-info {
            box-shadow: 0 0 10px rgba(23, 162, 184, 0.8), 0 0 20px rgba(23, 162, 184, 0.5);
        }
        /* Estilo para centrar el texto dentro del CircularDisplayWidget */
        .circular-display-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            pointer-events: none;
        }
        /* Ajuste para que el switch y el texto queden bien alineados */
        .form-check.form-switch {
            min-height: 1.75em;
            padding-left: 3.5em;
        }
        .form-check-input {
            width: 2.5em;
            height: 1.25em;
            margin-left: -3.5em;
        }
        /* Estilos específicos para el canvas del gráfico para asegurar responsividad */
        .widget-container canvas {
            max-width: 100%;
            height: auto;
        }
        /* Estilo para el DisplayWidget */
        .display-value {
            color: #007bff; /* Color primario de Bootstrap para destacar el valor */
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <header class="bg-white shadow-sm p-3 mb-4 rounded">
            <h3 class="text-center text-primary">Dashboard IoT Configurable con JSON</h3>
        </header>

        <!-- Aquí es donde nuestro dashboard se renderizará -->
        <div id="iot-dashboard-area">
            <div class="text-center p-5 text-muted">Cargando dashboard...</div>
        </div>

        <footer class="text-center text-muted mt-5 p-3 border-top">
            Proyecto IoT con JavaScript Vanilla & Bootstrap
        </footer>
    </div>

    <!-- Modal de Bootstrap para dashboards secundarios -->
    <div class="modal fade" id="iotDashboardModal" tabindex="-1" aria-labelledby="iotDashboardModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="iotDashboardModalLabel">Dashboard Secundario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- El contenido del dashboard secundario se renderizará aquí -->
            <div id="iot-modal-dashboard-area"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Incluir Bootstrap JS (necesario para los modales) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <!-- Nuestra biblioteca JS personalizada principal -->
    <script src="js/iotRenderer.js"></script>

    <!-- Script para cargar dinámicamente todos los widgets -->
    <script src="js/widgets/loadWidgets.js"></script>

    <script>
        // --- Ruta al archivo JSON del dashboard principal ---
        const MAIN_DASHBOARD_CONFIG_PATH = 'dashboardConfig.json'; // Nombre del archivo JSON

        // --- Configuración del WebSocket ---
        const WEBSOCKET_URL = 'ws://127.0.0.1:81/'; // ACTUALIZA CON LA IP REAL

        // --- Renderizar el Dashboard y Conectar WebSocket cuando el DOM esté listo ---
        document.addEventListener('DOMContentLoaded', () => {
            IOT_RENDERER.initWebSocket(WEBSOCKET_URL);

            // Cargar todos los scripts de widgets dinámicamente
            WIDGET_LOADER.loadAllWidgets()
                .then(() => {
                    console.log('DEBUG: Todos los scripts de widgets cargados y registrados.');
                    // Ahora, cargar la configuración del dashboard principal desde el archivo JSON
                    return fetch(MAIN_DASHBOARD_CONFIG_PATH);
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} al cargar ${MAIN_DASHBOARD_CONFIG_PATH}`);
                    }
                    return response.json();
                })
                .then(mainDashboardConfig => {
                    console.log(`DEBUG: Configuración del dashboard principal '${mainDashboardConfig.title}' cargada.`);
                    // Una vez que la configuración está cargada, renderizamos el dashboard
                    return IOT_RENDERER.renderDashboard(mainDashboardConfig, 'iot-dashboard-area');
                })
                .catch(error => {
                    console.error('ERROR: No se pudo renderizar el dashboard. Fallo en la carga de widgets o del JSON principal:', error);
                    const dashboardArea = document.getElementById('iot-dashboard-area');
                    if (dashboardArea) {
                        dashboardArea.innerHTML = `<div class="alert alert-danger text-center mt-3">
                            Error crítico al cargar el dashboard: ${error.message}
                        </div>`;
                    }
                });
        });
    </script>
</body>
</html>